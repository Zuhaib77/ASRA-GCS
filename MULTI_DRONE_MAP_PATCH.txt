# Multi-Drone Map Support Patch
# Apply these changes to professional_gcs_map.py

## Change 1: Modify __init__ to support multiple UAVs (line ~423)
# Replace:
#   self.uav_position = None  # (lat, lon)
#   self.uav_heading = 0.0
#   self.uav_altitude = 0.0
#   self.uav_speed = 0.0
# With:
#   self.uav_positions = {}  # drone_id -> {'lat': float, 'lon': float, 'heading': float, 'alt': float, 'speed': float, 'color': str}
#   self.uav_position = None  # Keep for backward compatibility
#   self.uav_heading = 0.0

## Change 2: Modify flight path for multi-drone (line ~433)
# Replace:
#   self.flight_path = deque(maxlen=1000)
# With:
#   self.flight_paths = {}  # drone_id -> deque of (lat, lon)
#   self.flight_path = deque(maxlen=1000)  # Keep for backward compatibility

## Change 3: Add multi-drone update method (after line ~1176)
# Add new method:

def update_uav_position_multi(self, drone_id: str, lat: float, lon: float, heading: float = 0, 
                              altitude: float = 0, speed: float = 0, color: str = "#FF0000"):
    """
    Update UAV position for multi-drone support
    
    Args:
        drone_id: Unique drone identifier
        lat: Latitude
        lon: Longitude
        heading: Heading in degrees
        altitude: Altitude in meters
        speed: Speed in m/s
        color: Drone color for display
    """
    # Store position
    self.uav_positions[drone_id] = {
        'lat': lat,
        'lon': lon,
        'heading': heading,
        'alt': altitude,
        'speed': speed,
        'color': color
    }
    
    # Add to flight path
    if drone_id not in self.flight_paths:
        self.flight_paths[drone_id] = deque(maxlen=1000)
    
    if lat != 0 or lon != 0:
        self.flight_paths[drone_id].append((lat, lon))
    
    # Update display
    self.update()

## Change 4: Modify _draw_uav to support multiple drones (line ~746)
# Replace entire _draw_uav method with:

def _draw_uav(self, painter: QPainter):
    """Draw all UAVs - Multi-drone support"""
    # Draw backward-compatible single UAV if set
    if self.uav_position:
        self._draw_single_uav(painter, self.uav_position[0], self.uav_position[1], 
                             self.uav_heading, self.uav_altitude, self.uav_speed,
                             self.colors['uav'], "")
    
    # Draw multi-drone UAVs
    for drone_id, data in self.uav_positions.items():
        color = QColor(data['color'])
        self._draw_single_uav(painter, data['lat'], data['lon'], data['heading'],
                             data['alt'], data['speed'], color, drone_id)

def _draw_single_uav(self, painter: QPainter, lat: float, lon: float, heading: float,
                    altitude: float, speed: float, color: QColor, label: str = ""):
    """Draw a single UAV marker"""
    x, y = self._latlon_to_screen(lat, lon)
    
    # Draw UAV aircraft symbol
    painter.save()
    painter.translate(x, y)
    painter.rotate(heading)
    
    # Aircraft body
    painter.setPen(QPen(color, 2))
    painter.setBrush(QBrush(color))
    
    # Fuselage
    painter.drawEllipse(-3, -12, 6, 24)
    
    # Wings
    painter.drawRect(-15, -3, 30, 6)
    
    # Tail
    painter.drawRect(-8, -15, 16, 4)
    
    painter.restore()
    
    # Draw heading line
    if heading != 0:
        painter.setPen(QPen(color.lighter(150), 2))
        end_x = x + 30 * math.sin(math.radians(heading))
        end_y = y - 30 * math.cos(math.radians(heading))
        painter.drawLine(x, y, int(end_x), int(end_y))
    
    # Draw info text
    painter.setPen(self.colors['text'])
    font = QFont("Arial", 8)
    painter.setFont(font)
    
    info_text = f"{label}\\nALT: {altitude:.1f}m\\nSPD: {speed:.1f}m/s" if label else f"ALT: {altitude:.1f}m\\nSPD: {speed:.1f}m/s"
    painter.drawText(x + 20, y - 10, info_text)

## Change 5: Modify _draw_flight_path for multi-drone (line ~668)
# Replace the flight path drawing section with:

def _draw_flight_path(self, painter: QPainter):
    """Draw all flight paths - Multi-drone support"""
    # Draw backward-compatible single path
    if len(self.flight_path) > 1:
        self._draw_single_flight_path(painter, list(self.flight_path), self.colors['flight_path'])
    
    # Draw multi-drone paths
    for drone_id, path in self.flight_paths.items():
        if len(path) > 1:
            drone_data = self.uav_positions.get(drone_id)
            color = QColor(drone_data['color']) if drone_data else QColor("#FF00FF")
            color.setAlpha(180)  # Slight transparency
            self._draw_single_flight_path(painter, list(path), color)

def _draw_single_flight_path(self, painter: QPainter, path: list, color: QColor):
    """Draw a single flight path"""
    if len(path) < 2:
        return
    
    painter.setPen(QPen(color, 2))
    
    points = []
    for lat, lon in path:
        x, y = self._latlon_to_screen(lat, lon)
        points.append(QPointF(x, y))
    
    polygon = QPolygonF(points)
    painter.drawPolyline(polygon)

## Change 6: Add backward-compatible wrapper (modify existing update_uav_position)
# Modify line ~1176 to delegate to new method:

def update_uav_position(self, lat: float, lon: float, heading: float = 0, altitude: float = 0, speed: float = 0):
    """Update UAV position (backward compatible - single drone)"""
    self.uav_position = (lat, lon)
    self.uav_heading = heading
    self.uav_altitude = altitude
    self.uav_speed = speed
    
    # Add to flight path
    if lat != 0 or lon != 0:
        self.flight_path.append((lat, lon))
    
    self.update()

# USAGE IN MAIN_WINDOW.PY:
# Change from:
#   self.map_widget.update_uav_position(lat, lon, heading)
# To:
#   self.map_widget.update_uav_position_multi(drone_id, lat, lon, heading, altitude, speed, drone.color)
